'use strict';

const user_names = function user_names_from_env() {
    var ids= {};
    var raw = ( process.env["USERS"] || "" ).split(";").map(x => x.split(","));
    for (var row of raw ) {
        var uid = row[0];
        for (var id of row) ids[id] = uid;
    }
    return ids;
}();

function user_name(headers) {
    var cookie = headers["Cookie"] || headers["cookie"] || "";
    var cookies = Object.fromEntries(cookie.split(";").map(x => x.split("=", 2).map(y => y.trim())));
    var { uid, hash } = cookies;

    var ok = hash == user_hash(uid);
    if (ok) return user_names[uid];
}

function user_hash(uid) {
    var crypto = require('crypto');
    var hash = crypto.createHash('md5')
        .update(uid + process.env.USER_HASH + new Date().toISOString().substr(0,8), 'utf8')     // utf-8, binary, or ascii
        .digest('base64').replace(/=/g, "");
    return hash;
}

module.exports = { user_name};
